# 知识图谱模块修改指南

## 问题背景
原知识图谱使用 Pyvis 库存在 Jinja2 模板渲染错误（'NoneType' object has no attribute 'render'），需要切换到 vis.js 直接生成 HTML。

---

## 修改步骤

### 1. 创建新的图谱模块文件

在 `modules/` 目录下创建 `knowledge_graph_interactive.py`，包含三个核心函数：

#### 函数1：`create_knowledge_graph_html(selected_node_id=None, filter_module=None)`

**功能**：生成包含 vis.js 的完整 HTML 页面

**关键配置**：
```python
# 节点配置
nodes.append({
    "id": node_id,
    "label": node_name,
    "color": "#FF6B6B",  # 模块用红色，章节用蓝色#4ECDC4，知识点用绿色#95E1D3
    "size": 40,  # 模块40，章节30，知识点20
    "shape": "dot",  # 圆形节点
    "borderWidth": 4,
    "font": {"size": 20, "color": "#000000", "bold": True}
})

# HTML 容器样式
"""
#mynetwork {
    width: 100%;
    height: 1000px;  /* 固定高度1000px */
    border: 1px solid #e0e0e0;
    background-color: #ffffff;
}
"""

# 物理引擎配置 - barnesHut算法
options = {
    physics: {
        enabled: true,
        solver: 'barnesHut',
        barnesHut: {
            gravitationalConstant: -35000,
            centralGravity: 0.1,
            springLength: 250,
            springConstant: 0.02,
            damping: 0.5,
            avoidOverlap: 1
        },
        stabilization: {
            enabled: true,
            iterations: 200,
            fit: true
        }
    }
}
```

**模块筛选逻辑**：
```python
# 根据filter_module参数过滤节点
if filter_module and filter_module in example_modules:
    modules_to_show = {filter_module: example_modules[filter_module]}
else:
    modules_to_show = example_modules
```

#### 函数2：`render_knowledge_graph_interactive()`

**功能**：渲染完整的知识图谱界面

**布局结构**：
```python
# 侧边栏：节点分类导航 + 搜索框 + 详情面板
with st.sidebar:
    st.header("🧭 导航")
    
    # 模块选择（单选框）
    module_options = {
        "全部": None,
        "M1 - 模块名称": "M1",
        # ...
    }
    selected_module_name = st.radio("选择模块", options=list(module_options.keys()))
    
    # 搜索框
    search_term = st.text_input("搜索知识点", placeholder="输入关键词...")
    
    # 详情面板
    render_node_detail_panel(st.session_state.get('selected_node'))

# 主区域：模块下拉选择框 + 颜色图例 + 图谱容器
filter_module = st.selectbox("筛选模块", options=list(module_options.keys()))

# 颜色图例
st.markdown("""
**节点图例**:
- 🔴 **红色节点**: 教学模块
- 🔵 **蓝色节点**: 章节
- 🟢 **绿色节点**: 知识点
""")

# 生成并显示图谱（固定高度1100px，启用滚动）
html_content = create_knowledge_graph_html(
    selected_node_id=st.session_state.get('selected_node'),
    filter_module=filter_module_id
)
components.html(html_content, height=1100, scrolling=True)
```

#### 函数3：`render_node_detail_panel(node)`

**功能**：在侧边栏显示选中节点的详细信息

```python
def render_node_detail_panel(node):
    if not node:
        st.sidebar.info("💡 点击左侧导航或图谱中的节点查看详情")
        return
    
    st.sidebar.markdown("---")
    st.sidebar.subheader("📌 节点详情")
    
    # 解析节点ID，提取模块、章节、知识点信息
    node_parts = node.split("_")
    if len(node_parts) >= 3:
        module_id = node_parts[0]
        chapter = node_parts[1]
        knowledge = "_".join(node_parts[2:])
        
        st.sidebar.markdown(f"**模块**: {module_id}")
        st.sidebar.markdown(f"**章节**: {chapter}")
        st.sidebar.markdown(f"**知识点**: {knowledge}")
```

---

### 2. 关键代码要点

#### 节点配置
```python
# 使用圆形节点（shape: "dot"）
nodes.append({
    "shape": "dot",  # 必须设置为dot才是圆形
    "size": 40,      # 控制节点大小
    "borderWidth": 4  # 边框宽度
})
```

#### HTML 容器样式
```css
#mynetwork {
    width: 100%;
    height: 1000px;  /* 固定高度，确保不是小长条 */
    border: 1px solid #e0e0e0;
    background-color: #ffffff;
}
```

#### 模块筛选逻辑
```python
# 在create_knowledge_graph_html函数中
if filter_module and filter_module in example_modules:
    modules_to_show = {filter_module: example_modules[filter_module]}
else:
    modules_to_show = example_modules

# 只为筛选后的模块创建节点和边
for m_id, m_info in modules_to_show.items():
    # 添加节点...
```

#### UI 布局
```python
# 使用 streamlit 的侧边栏和主区域
with st.sidebar:
    # 导航、搜索、详情
    
# 主区域
st.markdown("说明文字")
filter_module = st.selectbox("筛选模块", ...)
components.html(html_content, height=1100, scrolling=True)
```

---

### 3. 更新主应用文件

在 `app.py` 中进行以下修改：

#### 步骤1：更新导入语句
```python
# 原来的导入
from modules.knowledge_graph import render_knowledge_graph

# 修改为
from modules.knowledge_graph_interactive import render_knowledge_graph_interactive
```

#### 步骤2：更新函数调用
```python
# 找到调用知识图谱的地方，通常在页面路由部分
# 原来的调用
elif current == 'knowledge_graph':
    render_knowledge_graph()

# 修改为
elif current == 'knowledge_graph':
    render_knowledge_graph_interactive()
```

---

### 4. 删除旧文件（可选）

如果确认新模块工作正常，可以删除或重命名旧文件：
```bash
# 重命名旧文件作为备份
mv modules/knowledge_graph.py modules/knowledge_graph_old.py

# 或者直接删除
rm modules/knowledge_graph.py
```

---

## 关键改进点

✅ 使用 vis.js CDN 替代 Pyvis，避免模板问题  
✅ 节点形状设为圆形（shape: "dot"）  
✅ 容器高度固定 1000px，不再是小长条  
✅ 添加模块筛选下拉框，选择后图谱动态过滤  
✅ 保留侧边栏导航和详情面板  
✅ 支持节点点击高亮相关内容  
✅ 物理引擎使用 barnesHut 算法，优化布局  

---

## 测试要点

1. **页面加载**：图谱容器是否足够大（1000px高度）
2. **节点形状**：节点是否为圆形
3. **模块筛选**：选择模块后图谱是否正确过滤
4. **侧边栏交互**：点击侧边栏节点是否在图谱中高亮
5. **物理引擎**：节点是否正常布局，不重叠
6. **响应性**：鼠标拖拽、缩放、悬停是否正常工作

---

## 适配其他课程的步骤

### 步骤1：准备课程数据
修改 `knowledge_graph_interactive.py` 中的 `example_modules` 字典，替换为你的课程内容：

```python
example_modules = {
    "M1": {
        "name": "你的模块1名称",
        "description": "模块1描述",
        "chapters": {
            "章节1": ["知识点1", "知识点2", "知识点3"],
            "章节2": ["知识点4", "知识点5"]
        }
    },
    # 添加更多模块...
}
```

### 步骤2：更新知识点详情
修改 `knowledge_details` 字典，添加你的知识点说明：

```python
knowledge_details = {
    "知识点1": "这是知识点1的详细说明...",
    "知识点2": "这是知识点2的详细说明...",
    # 添加更多知识点...
}
```

### 步骤3：定义知识关联
修改 `knowledge_links` 列表，定义知识点之间的关联：

```python
knowledge_links = [
    ("知识点1", "知识点2", "前置"),
    ("知识点2", "知识点3", "关联"),
    # 添加更多关联...
]
```

### 步骤4：更新模块选择器
在 `render_knowledge_graph_interactive()` 函数中更新模块选项：

```python
module_options = {
    "全部": None,
    "M1 - 你的模块1": "M1",
    "M2 - 你的模块2": "M2",
    # 根据你的课程调整...
}
```

### 步骤5：测试并调整
- 运行应用，检查图谱是否正确显示
- 调整节点大小、颜色、布局参数以获得最佳视觉效果
- 测试所有交互功能

---

## 常见问题排查

### 问题1：图谱容器太小
**解决方案**：检查 CSS 中的 `height: 1000px` 和 `components.html(height=1100)`

### 问题2：节点不是圆形
**解决方案**：确认节点配置中 `"shape": "dot"`

### 问题3：模块筛选不工作
**解决方案**：检查 `create_knowledge_graph_html` 中的 `filter_module` 参数处理逻辑

### 问题4：节点重叠严重
**解决方案**：调整物理引擎参数，增大 `springLength` 或 `avoidOverlap` 值

### 问题5：vis.js 加载失败
**解决方案**：检查 CDN 链接是否可访问，或下载到本地使用

---

## 完整文件清单

修改涉及的文件：
1. ✅ `modules/knowledge_graph_interactive.py` - 新建
2. ✅ `app.py` - 修改导入和调用
3. ⚠️ `modules/knowledge_graph.py` - 可选删除/重命名

---

## 总结

通过以上步骤，你已经成功将知识图谱模块从 Pyvis 切换到 vis.js，解决了模板渲染问题，并获得了更好的交互体验和视觉效果。这套方案可以直接应用到其他课程的自适应学习系统中。

**核心改进**：
- 稳定性：避免了 Pyvis 的模板渲染错误
- 视觉效果：圆形节点 + 固定高度容器 + 优化布局
- 交互性：侧边栏导航 + 模块筛选 + 节点详情
- 可维护性：清晰的代码结构 + 易于扩展的数据格式

把这个指南保存下来，下次修改其他课程时直接参考即可！
